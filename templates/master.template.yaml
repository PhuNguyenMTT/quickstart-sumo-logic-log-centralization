AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: "This cloudformation set up AWS and Sumo Logic Resources for all the Sumo Logic Security apps part of AWS QuickStart Solution."

Metadata:

  ParameterGroups:
    - Label:
        default: "1. Sumo Logic Access Configuration (Required)"
      Parameters:
        - Section1aSumoLogicDeployment
        - Section1bSumoLogicAccessID
        - Section1cSumoLogicAccessKey
        - Section1dSumoLogicOrganizationId
        - Section1eSumoLogicResourceRemoveOnDeleteStack

    - Label:
        default: "2. Sumo Logic CloudTrail Apps Configurations"
      Parameters:
        - Section2aInstallCloudTrailApp
        - Section2bInstallPCICloudTrailApp
        - Section2cInstallCISFoundationApp
    - Label:
        default: "2.1 AWS S3 Bucket Configuration"
      Parameters:
        - Section2dCloudTrailCreateBucket
        - Section2eCloudTrailLogsBucketName
    - Label:
        default: "2.2 Sumo Logic CloudTrail Source Configuration"
      Parameters:
        - Section2fCloudTrailCreateLogSource
        - Section2gCloudTrailBucketPathExpression
        - Section2hCloudTrailLogsSourceCategoryName

    - Label:
        default: "3. Sumo Logic GuardDuty Apps Configurations"
      Parameters:
        - Section3aInstallGuardDutyApp
        - Section3bInstallGuardDutyBenchMarkApp
    - Label:
        default: "3.1 Sumo Logic GuardDuty Logs Source Configuration"
      Parameters:
        - Section3cGuardDutyCreateHttpLogsSource
        - Section3dGuardDutyHttpLogsSourceCategoryName

    - Label:
        default: "4. Sumo Logic VPC Flow Logs Apps Configurations"
      Parameters:
        - Section4aInstallVpcApp
        - Section4bInstallPCIVpcApp
    - Label:
        default: "4.1 AWS S3 Bucket Configuration"
      Parameters:
        - Section4cVpcCreateBucket
        - Section4dVpcLogsBucketName
    - Label:
        default: "4.2 Sumo Logic VPC S3 Source Configuration"
      Parameters:
        - Section4eVpcCreateS3Source
        - Section4fVpcBucketPathExpression
        - Section4gVpcLogsSourceCategoryName

    - Label:
        default: "5. Sumo Logic Threat Intel for AWS Configurations"
      Parameters:
        - Section5aInstallThreatIntelApp
        - Section5bElasticLoadBalancerSourceCategory

    - Label:
        default: "AWS Quick Start configuration"
      Parameters:
        - QSS3BucketName
        - QSS3BucketRegion
        - QSS3KeyPrefix

  ParameterLabels:
    Section1aSumoLogicDeployment:
      default: "Sumo Logic Deployment Name"
    Section1bSumoLogicAccessID:
      default: "Sumo Logic Access ID"
    Section1cSumoLogicAccessKey:
      default: "Sumo Logic Access Key"
    Section1dSumoLogicOrganizationId:
      default: "Sumo Logic Organization Id"
    Section1eSumoLogicResourceRemoveOnDeleteStack:
      default: "Delete Sumo Logic Resources when stack is deleted"

    # CloudTrail Apps Parameters
    Section2aInstallCloudTrailApp:
      default: "Install Sumo Logic AWS CloudTrail App"
    Section2bInstallPCICloudTrailApp:
      default: "Install Sumo Logic PCI Compliance For AWS CloudTrail App"
    Section2cInstallCISFoundationApp:
      default: "Install Sumo Logic CIS AWS Foundations Benchmark App"
    Section2dCloudTrailCreateBucket:
      default: "Create AWS S3 Bucket"
    Section2eCloudTrailLogsBucketName:
      default: "AWS S3 Bucket Name"
    Section2fCloudTrailCreateLogSource:
      default: "Create Sumo Logic CloudTrail Logs Source"
    Section2gCloudTrailBucketPathExpression:
      default: "Path Expression for the logs"
    Section2hCloudTrailLogsSourceCategoryName:
      default: "Sumo Logic CloudTrail Logs Source Category Name"

    # GuardDuty Apps Parameters
    Section3aInstallGuardDutyApp:
      default: "Install Sumo Logic Amazon GuardDuty App"
    Section3bInstallGuardDutyBenchMarkApp:
      default: "Install Sumo Logic Amazon GuardDuty BenchMark App"
    Section3cGuardDutyCreateHttpLogsSource:
      default: "Create Sumo Logic HTTP Logs Source"
    Section3dGuardDutyHttpLogsSourceCategoryName:
      default: "Sumo Logic HTTP Logs Source Category Name"

    # VPC Flow Logs Apps Parameters
    Section4aInstallVpcApp:
      default: "Install Sumo Logic Amazon VPC Flow Logs App"
    Section4bInstallPCIVpcApp:
      default: "Install Sumo Logic PCI Compliance For Amazon VPC Flow App"
    Section4cVpcCreateBucket:
      default: "Create AWS S3 Bucket"
    Section4dVpcLogsBucketName:
      default: "AWS S3 Bucket Name"
    Section4eVpcCreateS3Source:
      default: "Create Sumo Logic Amazon S3 Logs Source"
    Section4fVpcBucketPathExpression:
      default: "Path Expression for the logs"
    Section4gVpcLogsSourceCategoryName:
      default: "Sumo Logic Amazon S3 Logs Source Category Name"

    # Threat Intel for AWS Parameters
    Section5aInstallThreatIntelApp:
      default: "Install Sumo Logic Threat Intel for AWS App"
    Section5bElasticLoadBalancerSourceCategory:
      default: "Sumo Logic Amazon Elastic Load Balancer Classic Category Name"

    QSS3BucketName:
      default: "Quick Start S3 bucket name"
    QSS3BucketRegion:
      default: "Quick Start S3 bucket region"
    QSS3KeyPrefix:
      default: "Quick Start S3 key prefix"

Parameters:
  Section1aSumoLogicDeployment:
    Type: String
    AllowedValues:
      - au
      - ca
      - de
      - eu
      - jp
      - us2
      - us1
      - in
      - fed
    Description: "Enter au, ca, de, eu, jp, us2, in, fed or us1."
  Section1bSumoLogicAccessID:
    Type: String
    Description: "The Sumo Logic Access ID. Used for Sumo Logic API calls."
    AllowedPattern: ".+"
    ConstraintDescription: "Sumo Logic Access ID can not be empty."
  Section1cSumoLogicAccessKey:
    Type: String
    Description: "The Sumo Logic Access Key. Used for Sumo Logic API calls."
    AllowedPattern: ".+"
    ConstraintDescription: "Sumo Logic Access Key can not be empty."
    NoEcho: true
  Section1dSumoLogicOrganizationId:
    Description: "The Account Overview page displays information about your Sumo Logic organization. Used for IAM Role in Sumo Logic AWS Sources."
    Type: String
    AllowedPattern: ".+"
    ConstraintDescription: "Sumo Logic Organization Id can not be empty."
  Section1eSumoLogicResourceRemoveOnDeleteStack:
    AllowedValues:
      - true
      - false
    Default: true
    Description: "To delete collectors, sources and apps when the stack is deleted, set this parameter to true. Default is true.
                  Deletes the resources created by the stack. Deletion of updated resources will be skipped."
    Type: String

  # CloudTrail Apps Parameters
  Section2aInstallCloudTrailApp:
    Type: String
    Description: "Yes -> Install Sumo Logic AWS CloudTrail App in Sumo Logic for AWS Quick Start Solution.
                  No -> Skip Installation of the app."
    Default: 'Yes'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section2bInstallPCICloudTrailApp:
    Type: String
    Description: "Yes -> Install PCI Compliance For AWS CloudTrail App in Sumo Logic for AWS Quick Start Solution.
                  No -> Skip Installation of the app."
    Default: 'Yes'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section2cInstallCISFoundationApp:
    Type: String
    Description: "Yes -> Install CIS AWS Foundations Benchmark App in Sumo Logic for AWS Quick Start Solution.
                  No -> Skip Installation of the app."
    Default: 'Yes'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section2dCloudTrailCreateBucket:
    Type: String
    Description: "Yes - Create a new CloudTrail bucket in AWS S3.
                  No - Use an existing CloudTrail bucket from AWS S3 which has CloudTrail Logs."
    Default: 'Yes'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section2eCloudTrailLogsBucketName:
    Type: String
    Description: "Required when Flag = No. Provide an Existing bucket name which has CloudTrail logs."
    Default: ""
  Section2fCloudTrailCreateLogSource:
    Type: String
    Description: "Yes - Create Sumo Logic Cloud Trail Log Source with provided bucket Name.
                  No - Skip creation of the Sumo Logic Cloud Trail Log Source."
    Default: 'Yes'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section2gCloudTrailBucketPathExpression:
    Type: String
    Description: "Path expression to match the folder structure for CloudTrail logs. For Eg:- AWSLogs/*/cloudtrail/*"
    Default: "*"
  Section2hCloudTrailLogsSourceCategoryName:
    Type: String
    Description: "Required when Flag = No. Provide an existing source category name from Sumo Logic collecting CloudTrail Logs. Used for Threat Intel for AWS app installation also."
    Default: ""

  # GuardDuty Apps Parameters
  Section3aInstallGuardDutyApp:
    Type: String
    Description: "Yes -> Install Amazon GuardDuty App in Sumo Logic for AWS Quick Start Solution.
                  No -> Skip Installation of the app."
    Default: 'Yes'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section3bInstallGuardDutyBenchMarkApp:
    Type: String
    Description: "Yes -> Install Amazon GuardDuty BenchMark App in Sumo Logic for AWS Quick Start Solution.
                  No -> Skip Installation of the app."
    Default: 'Yes'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section3cGuardDutyCreateHttpLogsSource:
    Type: String
    Description: "Yes - Create Sumo Logic HTTP Log Source to collect GuardDuty logs..
                  No - Skip creation of the Sumo Logic HTTP Log Source."
    Default: 'Yes'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section3dGuardDutyHttpLogsSourceCategoryName:
    Type: String
    Description: "Required when Flag = No. Provide an existing source category name from Sumo Logic collecting GuardDuty Logs. Used for app installation."
    Default: ""

  # VPC Flow Logs Apps Parameters
  Section4aInstallVpcApp:
    Type: String
    Description: "Yes -> Install Sumo Logic Amazon VPC Flow Logs in Sumo Logic for AWS Quick Start Solution.
                  No -> Skip Installation of the app."
    Default: 'Yes'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section4bInstallPCIVpcApp:
    Type: String
    Description: "Yes -> Install PCI Compliance For Amazon VPC Flow App in Sumo Logic for AWS Quick Start Solution.
                  No -> Skip Installation of the app."
    Default: 'Yes'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section4cVpcCreateBucket:
    Type: String
    Description: "Yes - Create a new S3 bucket in AWS S3.
                  No - Use an existing S3 bucket from AWS S3 which has VPC Logs."
    Default: 'Yes'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section4dVpcLogsBucketName:
    Type: String
    Description: "Required when Flag = No. Provide an Existing bucket name which has VPC Flow logs."
    Default: ""
  Section4eVpcCreateS3Source:
    Type: String
    Description: "Yes - Create Sumo Logic Amazon S3 Log Source with provided bucket Name.
                  No - Skip creation of the Sumo Logic Amazon S3 Log Source."
    Default: 'Yes'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section4fVpcBucketPathExpression:
    Type: String
    Description: "Path expression to match the folder structure for VPC Flow logs. For Eg:- VPC-FLOW-LOGS/*."
    Default: "VPC-FLOW-LOGS/*"
  Section4gVpcLogsSourceCategoryName:
    Type: String
    Description: "Required when Flag = No. Provide an existing source category name from Sumo Logic collecting VPC Flow Logs. Used for Threat Intel for AWS app installation also."
    Default: ""

  # Threat Intel for AWS Parameters
  Section5aInstallThreatIntelApp:
    Type: String
    Description: "Yes -> Install Sumo Logic Threat Intel for AWS app in Sumo Logic for AWS Quick Start Solution.
                  No -> Skip Installation of the app."
    Default: 'Yes'
    AllowedValues:
      - 'Yes'
      - 'No'
  Section5bElasticLoadBalancerSourceCategory:
    Type: String
    Description: "Provide an existing Source Category from Sumo Logic with Elastic Load Balancer Classic Logs."
    Default: ""

  QSS3BucketName:
    AllowedPattern: "^[0-9a-zA-Z]+([0-9a-zA-Z-]*[0-9a-zA-Z])*$"
    ConstraintDescription: "Quick Start bucket name can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-)."
    Default: "aws-quickstart"
    Description: "S3 bucket name for the Quick Start assets. This string can include numbers, lowercase letters, uppercase letters, and hyphens (-). It cannot start or end with a hyphen (-)."
    Type: "String"
  QSS3BucketRegion:
    Default: "us-east-1"
    Description: "The AWS Region where the Quick Start S3 bucket (QSS3BucketName) is hosted. When using your own bucket, you must specify this value."
    Type: String
  QSS3KeyPrefix:
    AllowedPattern: "^[0-9a-zA-Z-/]*$"
    ConstraintDescription: "Quick Start key prefix can include numbers, lowercase letters, uppercase letters, hyphens (-), and forward slash (/)."
    Default: "quickstart-sumo-logic-log-centralization/"
    Description: "S3 key prefix for the Quick Start assets. Quick Start key prefix can include numbers, lowercase letters, uppercase letters, hyphens (-), and forward slash (/)."
    Type: "String"

Conditions:
  # Conditions for CloudTrail Apps
  install_cloudtrail_app: !Equals [ !Ref Section2aInstallCloudTrailApp, 'Yes' ]
  install_pci_cloudtrail_app: !Equals [ !Ref Section2bInstallPCICloudTrailApp, 'Yes' ]
  install_cis_foundations_app: !Equals [ !Ref Section2cInstallCISFoundationApp, 'Yes' ]
  create_cloudtrail_bucket: !Equals [ !Ref Section2dCloudTrailCreateBucket, 'Yes' ]
  create_cloudtrail_source: !Equals [ !Ref Section2fCloudTrailCreateLogSource, 'Yes' ]

  # Conditions for GuardDuty Apps
  install_guardduty_app: !Equals [ !Ref Section3aInstallGuardDutyApp, 'Yes' ]
  install_guardduty_benchmark_app: !Equals [ !Ref Section3bInstallGuardDutyBenchMarkApp, 'Yes' ]
  create_guardduty_source: !Equals [ !Ref Section3cGuardDutyCreateHttpLogsSource, 'Yes' ]

  # Conditions for VPC Flow Logs Apps
  install_vpc_app: !Equals [ !Ref Section4aInstallVpcApp, 'Yes' ]
  install_pci_vpc_app: !Equals [ !Ref Section4bInstallPCIVpcApp, 'Yes' ]
  create_vpc_bucket: !Equals [ !Ref Section4cVpcCreateBucket, 'Yes' ]
  create_vpc_source: !Equals [ !Ref Section4eVpcCreateS3Source, 'Yes' ]

  # Conditions for Threat Intel App
  install_threat_intel_app: !Equals [ !Ref Section5aInstallThreatIntelApp, 'Yes' ]

  # Conditions for Common
  create_common_s3_bucket: !Or
    - !Condition create_cloudtrail_bucket
    - !Condition create_vpc_bucket
  create_common_collector: !Or
    - !Condition create_cloudtrail_source
    - !Condition create_guardduty_source
    - !Condition create_vpc_source
  create_cloudtrail: !Condition create_cloudtrail_bucket

  # Conditions for calling child stack of each app. If any resource create condition is true.
  call_cloudtrail_stack: !Or
    - !Condition install_cloudtrail_app
    - !Condition install_pci_cloudtrail_app
    - !Condition install_cis_foundations_app
    - !Condition create_cloudtrail_source
  call_guardduty_stack: !Or
    - !Condition install_guardduty_app
    - !Condition install_guardduty_benchmark_app
    - !Condition create_guardduty_source
  call_vpc_stack: !Or
    - !Condition install_vpc_app
    - !Condition install_pci_vpc_app
    - !Condition create_vpc_source
  call_threat_intel_stack: !Condition install_threat_intel_app

  UsingDefaultBucket: !Equals [!Ref QSS3BucketName, 'aws-quickstart']

Resources:

  WaitHandle:
    Type: "AWS::CloudFormation::WaitConditionHandle"

  CreateCommonResources:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}submodules/sumo-aws-apps/common/resources.template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        SumoDeployment: !Ref Section1aSumoLogicDeployment
        SumoAccessID: !Ref Section1bSumoLogicAccessID
        SumoAccessKey: !Ref Section1cSumoLogicAccessKey
        SumoOrganizationId: !Ref Section1dSumoLogicOrganizationId
        RemoveSumoResourcesOnDeleteStack: !Ref Section1eSumoLogicResourceRemoveOnDeleteStack
        CreateCollector: !If [create_common_collector, 'Yes', 'No']
        CollectorName: !Sub "aws-quickstart-collector"
        CreateBucket: !If [create_common_s3_bucket, 'Yes', 'No']
        BucketName: !Sub "aws-quickstart-logs-${AWS::Region}-${AWS::AccountId}"
        CreateTrail: !If [create_cloudtrail, 'Yes', 'No']
        QSS3BucketName: !Ref QSS3BucketName
        QSS3BucketRegion: !Ref QSS3BucketRegion
        QSS3KeyPrefix: !Ref QSS3KeyPrefix

  sumoCloudTrailAppsStack:
    Type: AWS::CloudFormation::Stack
    Condition: call_cloudtrail_stack
    DependsOn: CreateCommonResources
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}submodules/sumo-aws-apps/cloudtrail/cloudtrail.template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        SumoDeployment: !Ref Section1aSumoLogicDeployment
        SumoAccessID: !Ref Section1bSumoLogicAccessID
        SumoAccessKey: !Ref Section1cSumoLogicAccessKey
        SumoOrganizationId: !Ref Section1dSumoLogicOrganizationId
        RemoveSumoResourcesOnDeleteStack: !Ref Section1eSumoLogicResourceRemoveOnDeleteStack
        InstallCloudTrailApp: !Ref Section2aInstallCloudTrailApp
        InstallPCICloudTrailApp: !Ref Section2bInstallPCICloudTrailApp
        InstallCISFoundationApp: !Ref Section2cInstallCISFoundationApp
        CollectorName: !Sub "aws-quickstart-collector"
        CreateCloudTrailBucket: "No"
        CloudTrailLogsBucketName: !If [create_cloudtrail_bucket, !Sub "aws-quickstart-logs-${AWS::Region}-${AWS::AccountId}", !Ref Section2eCloudTrailLogsBucketName]
        CreateCloudTrailLogSource: !If [create_cloudtrail_source, "Yes", "No"]
        CloudTrailBucketPathExpression: !If [create_cloudtrail_bucket, !Sub "AWSLogs/${AWS::AccountId}/CloudTrail/*", !Ref Section2gCloudTrailBucketPathExpression]
        CloudTrailLogsSourceName: !Sub "aws-quickstart-cloudtrail-${AWS::Region}"
        CloudTrailLogsSourceCategoryName: !If [create_cloudtrail_source, "aws/quickstart/cloudtrail/logs", !Ref Section2hCloudTrailLogsSourceCategoryName]
        QSS3BucketName: !Ref QSS3BucketName
        QSS3BucketRegion: !Ref QSS3BucketRegion
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        ParentStackName: !GetAtt CreateCommonResources.Outputs.StackName

  sumoGuardDutyStackWaitHandle:
    Condition: call_cloudtrail_stack
    DependsOn: sumoCloudTrailAppsStack
    Type: "AWS::CloudFormation::WaitConditionHandle"

  sumoGuardDutyStackWaitCondition:
    Type: "AWS::CloudFormation::WaitCondition"
    Properties:
      Handle: !If [call_cloudtrail_stack, !Ref sumoGuardDutyStackWaitHandle, !Ref WaitHandle]
      Timeout: "5"
      Count: 0

  sumoGuardDutyAppsStack:
    Type: AWS::CloudFormation::Stack
    Condition: call_guardduty_stack
    DependsOn: sumoGuardDutyStackWaitCondition
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}submodules/sumo-aws-apps/guardduty/guardduty.template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        SumoDeployment: !Ref Section1aSumoLogicDeployment
        SumoAccessID: !Ref Section1bSumoLogicAccessID
        SumoAccessKey: !Ref Section1cSumoLogicAccessKey
        RemoveSumoResourcesOnDeleteStack: !Ref Section1eSumoLogicResourceRemoveOnDeleteStack
        InstallGuardDutyApp: !Ref Section3aInstallGuardDutyApp
        InstallGuardDutyBenchMarkApp: !Ref Section3bInstallGuardDutyBenchMarkApp
        CollectorName: !Sub "aws-quickstart-collector"
        CreateHttpLogsSource: !If [create_guardduty_source, "Yes", "No"]
        HttpLogsSourceName: !Sub "aws-quickstart-guardduty-${AWS::Region}"
        HttpLogsSourceCategoryName: !If [create_guardduty_source, "aws/quickstart/guardduty/logs", !Ref Section3dGuardDutyHttpLogsSourceCategoryName]
        QSS3BucketName: !Ref QSS3BucketName
        QSS3BucketRegion: !Ref QSS3BucketRegion
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        ParentStackName: !GetAtt CreateCommonResources.Outputs.StackName

  sumoVpcStackWaitHandle:
    Condition: call_guardduty_stack
    DependsOn: sumoGuardDutyAppsStack
    Type: "AWS::CloudFormation::WaitConditionHandle"

  sumoVpcStackWaitCondition:
    Type: "AWS::CloudFormation::WaitCondition"
    Properties:
      Handle: !If [call_guardduty_stack, !Ref sumoVpcStackWaitHandle, !Ref WaitHandle]
      Timeout: "5"
      Count: 0

  sumoVpcAppsStack:
    Type: AWS::CloudFormation::Stack
    Condition: call_vpc_stack
    DependsOn: sumoVpcStackWaitCondition
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}submodules/sumo-aws-apps/vpc-flow-logs/vpcflowlogs.template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        SumoDeployment: !Ref Section1aSumoLogicDeployment
        SumoAccessID: !Ref Section1bSumoLogicAccessID
        SumoAccessKey: !Ref Section1cSumoLogicAccessKey
        SumoOrganizationId: !Ref Section1dSumoLogicOrganizationId
        RemoveSumoResourcesOnDeleteStack: !Ref Section1eSumoLogicResourceRemoveOnDeleteStack
        InstallVpcApp: !Ref Section4aInstallVpcApp
        InstallPCIVpcApp: !Ref Section4bInstallPCIVpcApp
        CollectorName: !Sub "aws-quickstart-collector"
        CreateS3Bucket: "No"
        LogsS3BucketName: !If [create_vpc_bucket, !Sub "aws-quickstart-logs-${AWS::Region}-${AWS::AccountId}", !Ref Section4dVpcLogsBucketName]
        CreateS3Source: !If [create_vpc_source, "Yes", "No"]
        S3BucketLogsPathExpression: !If [create_vpc_bucket, !Sub "VPC-FLOW-LOGS/*", !Ref Section4fVpcBucketPathExpression]
        S3SourceName: !Sub "aws-quickstart-vpc-${AWS::Region}"
        S3SourceCategoryName: !If [create_vpc_source, "aws/quickstart/vpc/logs", !Ref Section4gVpcLogsSourceCategoryName]
        # TODO
        AutoEnableVpcFlowLogs: "No"
        FilterExpression: ""
        QSS3BucketName: !Ref QSS3BucketName
        QSS3BucketRegion: !Ref QSS3BucketRegion
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        ParentStackName: !GetAtt CreateCommonResources.Outputs.StackName

  sumoThreatIntelStackWaitHandle:
    Condition: call_vpc_stack
    DependsOn: sumoVpcAppsStack
    Type: "AWS::CloudFormation::WaitConditionHandle"

  sumoThreatIntelStackWaitCondition:
    Type: "AWS::CloudFormation::WaitCondition"
    Properties:
      Handle: !If [call_vpc_stack, !Ref sumoThreatIntelStackWaitHandle, !Ref WaitHandle]
      Timeout: "5"
      Count: 0

  sumoThreatIntelAppsStack:
    Type: AWS::CloudFormation::Stack
    Condition: call_threat_intel_stack
    DependsOn: sumoVpcStackWaitCondition
    Properties:
      TemplateURL: !Sub
        - 'https://${S3Bucket}.s3.${S3Region}.${AWS::URLSuffix}/${QSS3KeyPrefix}submodules/sumo-aws-apps/threat-intel-for-aws/threatintel.template.yaml'
        - S3Region: !If [UsingDefaultBucket, !Ref 'AWS::Region', !Ref QSS3BucketRegion]
          S3Bucket: !If [UsingDefaultBucket, !Sub '${QSS3BucketName}-${AWS::Region}', !Ref QSS3BucketName]
      Parameters:
        SumoDeployment: !Ref Section1aSumoLogicDeployment
        SumoAccessID: !Ref Section1bSumoLogicAccessID
        SumoAccessKey: !Ref Section1cSumoLogicAccessKey
        RemoveSumoResourcesOnDeleteStack: !Ref Section1eSumoLogicResourceRemoveOnDeleteStack
        CloudTrailSourceCategory: !If [create_cloudtrail_source, "aws/quickstart/cloudtrail/logs", !Ref Section2hCloudTrailLogsSourceCategoryName]
        VPCFlowLogsSourceCategory: !If [create_vpc_source, "aws/quickstart/vpc/logs", !Ref Section4gVpcLogsSourceCategoryName]
        ElasticLoadBalancerSourceCategory: !Ref Section5bElasticLoadBalancerSourceCategory
        QSS3BucketName: !Ref QSS3BucketName
        QSS3BucketRegion: !Ref QSS3BucketRegion
        QSS3KeyPrefix: !Ref QSS3KeyPrefix
        ParentStackName: !GetAtt CreateCommonResources.Outputs.StackName